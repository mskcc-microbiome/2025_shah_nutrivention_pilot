[
  {
    "objectID": "summaries/00-example_summary.html",
    "href": "summaries/00-example_summary.html",
    "title": "Example Summary",
    "section": "",
    "text": "Example Summary of Data:\nThese documents are formatted more as html documents, embedding images from the various analysis notebooks. Where possible I liked to reference the dated versions of figures so that they don’t accidentally get overwritten in the future.\n\n\nLook here - an example image embedded in a dropdown! :)\n\n   \nThen add text to explain the figures etc.",
    "crumbs": [
      "Analyses",
      "Example Summary"
    ]
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "NUTRIVENTION Clinical Trial and Preclinical Vk*MYC Model",
    "section": "",
    "text": "This site is dedicated to the corresponding manuscript: “A High-Fiber Plant-Based Diet in Myeloma Precursor Disorders – Results from the NUTRIVENTION Clinical Trial and Preclinical Vk*MYC Model”\nWhere possible code has been written so that it can be executed from this repository. However there are certain types of data we are not able to make public. Cells which rely on private data will be marked as not executable, however, even in cases where the data is not public all to code used to generate figures is here.\nThis is a Quarto website.\nTo learn more about Quarto websites visit https://quarto.org/docs/websites.",
    "crumbs": [
      "Analyses",
      "Overview of all Analyses"
    ]
  },
  {
    "objectID": "01-project_notes_and_intro.html",
    "href": "01-project_notes_and_intro.html",
    "title": "Project Overview/Introduction",
    "section": "",
    "text": "- Goal 1!\n- and... goal 2",
    "crumbs": [
      "Project Information",
      "Introduction"
    ]
  },
  {
    "objectID": "01-project_notes_and_intro.html#goals",
    "href": "01-project_notes_and_intro.html#goals",
    "title": "Project Overview/Introduction",
    "section": "",
    "text": "- Goal 1!\n- and... goal 2",
    "crumbs": [
      "Project Information",
      "Introduction"
    ]
  },
  {
    "objectID": "00-notes_browsing.html",
    "href": "00-notes_browsing.html",
    "title": "Notes",
    "section": "",
    "text": "Collection of notes/updates/what I have tried. Organized so most recent stuff is at the top.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nExample Meeting Note\n\n\n\n\n\n\n\n\n\n\n\nFeb 4, 2025\n\n\n\n\n\n\nNo matching items",
    "crumbs": [
      "Project Information",
      "View Notes"
    ]
  },
  {
    "objectID": "analyses/00-first_pass_analysis.html",
    "href": "analyses/00-first_pass_analysis.html",
    "title": "First Pass Analysis",
    "section": "",
    "text": "[1] \"figures/png/example_figure.png\""
  },
  {
    "objectID": "notes/example_notes.html",
    "href": "notes/example_notes.html",
    "title": "Example Meeting Note",
    "section": "",
    "text": "Examples of a note page for a meeting:"
  },
  {
    "objectID": "notes/example_notes.html#summary",
    "href": "notes/example_notes.html#summary",
    "title": "Example Meeting Note",
    "section": "Summary:",
    "text": "Summary:\nOne to two sentence summary.\n\nAttendees:\n\nPerson 1\nPerson 2 ….\n\n\n\nAction Items:\n\nImportant thing to do 1\nImportant thing to do 2….."
  },
  {
    "objectID": "analyses/rna_seq.html",
    "href": "analyses/rna_seq.html",
    "title": "RNA Seq Analysis",
    "section": "",
    "text": "In this document you can find the assorted scripts for performing the single cell RNA-seq analysis for this manuscript. The author of this code is\n\npoporder &lt;- c(\"preB\", \"proB\", \"B naive\", \"B memory\", \"Plasma\", \n              \"BaMoP\", \"HSCs\", \"MEP\", \"GMP\", \n              \"CD14 monos\", \"CD16 monos\", \"MDSC\", \"MAIT\",\n              \"CD4 Naive\", \"CD4 CM\", \"CD4 EM\", \"CD4 Th1\", \"CD4 Th17\", \"CD4 Tregs\", \n              \"CD8 naive\", \"CD8 CM\", \"CD8 cytotox\", \"CD8 exhausted\",\n              \"gdT cells\", \"Stromal\",\n              \"NKs CD56 dim\", \"NKs CD56 bright\", \"ILC\", \n              \"pDC\", \"cDC2\")\n\npopcolor &lt;- setNames(nm = poporder,\n                     object = c(\"#793742\", stepped()[1:4], #B\n                                stepped()[5:8], #prog\n                                stepped()[9:11], alphabet(2), #monos\n                                \"#1F5863\", stepped()[13:16], #cd4 #\"#053841\", \n                                stepped()[17:20], #cd8\n                                stepped()[22], alphabet()[1], #others\n                                stepped3()[6:7], alphabet()[8], #nk\n                                stepped2()[17:18])) #DC\n\nno_mypops &lt;- c(\"MAIT\", \"gdT cells\", \"ILC\", \"BaMoP\", \"Stromal\", \"CD4 Tregs\", \"CD8 CM\")\nmypops &lt;- c(\"GMP\", \"CD14 monos\", \"CD16 monos\", \"MDSC\", \"CD8 cytotox\", \"CD8 exhausted\", \"NKs CD56 dim\", \"NKs CD56 bright\")\n\ndatapath &lt;- \"data location of GEX and ATAC info\"\n\n# gene annotation for ATAC data\nensdbs &lt;- query(AnnotationHub(), c(\"EnsDb.Hsapiens\"))\nensdb_id &lt;- ensdbs$ah_id[grep(paste0(\" 98 EnsDb\"), ensdbs$title)]\nensdb &lt;- ensdbs[[ensdb_id]]\n\nseqlevelsStyle(ensdb) &lt;- \"UCSC\"\nannotations &lt;- GetGRangesFromEnsDb(ensdb = ensdb)\ngenome(annotations) &lt;- \"GRCh37\"\n\n\n(myfiles &lt;- list.files(datapath, pattern = \"multiome$\"))\naux_seurat &lt;- lapply(1:length(myfiles), function(x){\n    print(samplename &lt;- myfiles[x])\n\n    aux &lt;- suppressMessages(Read10X(paste0(datapath, samplename, \"/CellRangerArc_results/filtered_feature_bc_matrix\")))\n    aux_hto &lt;- Read10X(paste0(datapath, samplename, \"_HTO/Hashtag_results/readCountMatrix\"), gene.column = 1) #https://github.com/satijalab/seurat/issues/4046#issue-803280332\n    colnames(aux_hto) &lt;- paste0(colnames(aux_hto), \"-1\") #cell bc don't include \"-1\"\n    \n    ## intersection between HTO and GEX\n    isec &lt;- intersect(colnames(aux$`Gene Expression`), colnames(aux_hto))\n\n    aux2 &lt;- CreateSeuratObject(counts = Matrix::Matrix(aux$`Gene Expression`[,isec], sparse = T),\n                               min.cells = 0, project = samplename)\n    aux2[[\"ATAC\"]] &lt;- CreateChromatinAssay(counts = Matrix::Matrix(aux$Peaks[,isec], sparse = T),\n        fragments = paste0(datapath, samplename, \"/CellRangerArc_results/atac_fragments.tsv.gz\"), \n        genome = \"GRCh37\", annotation = annotations, sep = c(\":\", \"-\"), verbose = F)\n    aux2[[\"HTO\"]] &lt;- CreateAssayObject(counts = aux_hto[,isec]+1) #sum 1 to avoid dropout errors when demux (https://github.com/satijalab/seurat/issues/5640#issuecomment-1051221101)\n    \n  ## normalization\n    aux2 &lt;- NormalizeData(aux2, verbose = F)\n    aux2 &lt;- FindVariableFeatures(aux2, verbose = F)\n    aux2 &lt;- ScaleData(aux2, features = VariableFeatures(aux2), verbose = F)\n\n    aux2 &lt;- NormalizeData(aux2, assay = \"HTO\", normalization.method = \"CLR\", margin = 2, verbose = F)\n\n    ## add QC info\n    aux2 &lt;- PercentageFeatureSet(aux2, pattern = \"^MT-\", col.name = \"percent.mt\", assay = \"RNA\")\n    aux2 &lt;- NucleosomeSignal(aux2, assay = \"ATAC\", verbose = F)\n    aux2 &lt;- TSSEnrichment(aux2, assay = \"ATAC\", verbose = F)\n\n    aux2 &lt;- RenameCells(aux2, add.cell.id = x) #make cells patient-specific\n    return(aux2)\n}); names(aux_seurat) &lt;- myfiles\n\n### filtering ####\naux &lt;- lapply(aux_seurat, function(x){\n    return(x@meta.data[,c(\"orig.ident\", \"nFeature_RNA\", \"percent.mt\", \"nFeature_ATAC\", \"TSS.enrichment\", \"nucleosome_signal\")])\n}) %&gt;% do.call(rbind, .) %&gt;% melt(id.vars = \"orig.ident\")\n\naux_seurat_f &lt;- lapply(aux_seurat, function(x){\n    aux &lt;- subset(x, subset = nFeature_RNA &gt; 500 & nFeature_RNA &lt; 5000 &\n                              percent.mt &lt; 25 &\n                              nFeature_ATAC &gt; 500 & nFeature_ATAC &lt; 20000 &\n                              TSS.enrichment &gt; 1 &\n                              nucleosome_signal &lt; 2)\n    return(aux)\n})\naux_seurat_f &lt;- lapply(aux_seurat_f, function(x) {x$samplename &lt;- x$orig.ident; return(x)})\n\n\n### sample demultiplexing ####\n# HTODemux (Seurat's)\naux_seurat_f &lt;- lapply(aux_seurat_f, function(x){\n    return(HTODemux(x, assay = \"HTO\", verbose = F))\n}); names(aux_seurat_f) &lt;- myfiles\n\naux &lt;- lapply(aux_seurat_f, function(x){\n    return(x@meta.data[,c(\"orig.ident\", \"HTO_maxID\", \"HTO_secondID\", \"HTO_classification\", \"hash.ID\")])\n}) %&gt;% do.call(rbind, .)\n\n#| scDemultiplex (HTO)\nlibrary(scDemultiplex); library(zoo)\n\naux_seurat_f &lt;- lapply(1:length(aux_seurat_f), function(x){\n  print(names(aux_seurat)[x])\n\n  obj &lt;- aux_seurat_f[[x]]\n  DefaultAssay(object = obj) &lt;- \"HTO\"\n\n  tagnames &lt;- rownames(obj[[\"HTO\"]])\n\n  obj &lt;- ScaleData(obj, features = tagnames, verbose = F)\n  obj &lt;- RunPCA(obj, features = tagnames, verbose = F, approx = F)\n  obj &lt;- RunUMAP(obj, features = tagnames, slot = \"scale.data\", verbose = F)\n\n  obj &lt;- demulti_cutoff(obj, mc.cores = 15)\n  return(obj)\n}); names(aux_seurat_f) &lt;- myfiles\n\naux &lt;- lapply(aux_seurat_f, function(x){\n    return(x@meta.data[,c(\"orig.ident\", \"scDemultiplex_cutoff\", \"scDemultiplex_cutoff.global\")])\n}) %&gt;% do.call(rbind, .)\n\n\n#| scds (GEX)\nlibrary(scds)\n\naux &lt;- lapply(1:length(aux_seurat_f), function(x){\n  print(names(aux_seurat)[x])\n\n  sce &lt;- as.SingleCellExperiment(CreateSeuratObject(as.matrix(aux_seurat_f[[x]]@assays$RNA@counts), min.cells = 0))\n  sce &lt;- cxds_bcds_hybrid(sce, estNdbl = T)\n\n  return(as.Seurat(sce))\n})\n\naux_seurat_f &lt;- mapply(function(x, y){\n    aux_seurat_f[[x]]$scds_call &lt;- aux[[y]]$hybrid_call\n    return(aux_seurat_f[[x]])\n}, x = 1:length(aux_seurat_f), y = 1:length(aux))\n\naux &lt;- lapply(aux_seurat_f, function(x){\n    return(x@meta.data[,c(\"orig.ident\", \"scds_call\")])\n}) %&gt;% do.call(rbind, .)\n\n### filter out doublets\" \n    #| 1. Union of singlets from HTODemux and scDemultiplexing\n    #| 2. Remove those \"doublets\" according GEX approach (ie, scds)\n\naux_seurat_ff &lt;- lapply(aux_seurat_f, function(x){\n    aux &lt;- x@meta.data[,c(\"orig.ident\", \"hash.ID\", \"scDemultiplex_cutoff\", \"scds_call\")]\n    tokeep &lt;- rownames(aux[\n    (!(aux$hash.ID %in% c(\"Negative\", \"Doublet\")) | \n        !(aux$scDemultiplex_cutoff %in% c(\"Doublet\", \"Negative\", \"unmapped\"))) &\n    aux$scds_call == FALSE,])\n    \n    return(x[,tokeep])\n}); names(aux_seurat_ff) &lt;- myfiles\n\n\n#| assign demultiplexing to samples\naux_seurat_ff &lt;- lapply(1:length(aux_seurat_ff), function(x){\n    print(names(aux_seurat_ff)[x])\n    aux &lt;- aux_seurat_ff[[x]]\n\n    aux$demux_barcode &lt;- ifelse(aux$HTO_classification.global == \"Singlet\", aux$HTO_classification, \n                                as.character(aux$scDemultiplex_cutoff))\n    aux$demux_barcode &lt;- gsub(\"-.*\", \"\", aux$demux_barcode)\n    return(aux)\n}); names(aux_seurat_ff) &lt;- myfiles\n\nsapply(USE.NAMES = T, aux_seurat_ff, FUN = ncol) #compare with merged object below\n\n\n### merge all together and SCT ####\nall_merge &lt;- merge(aux_seurat_ff[[1]], y = aux_seurat_ff[-1], project = \"scNUTRI\")\n\ntokeep &lt;- which(rowSums(all_merge@assays$RNA@counts) &gt; 0); length(tokeep) #32649\nall_merge &lt;- all_merge[tokeep,]\n\nall_merge &lt;- SCTransform(all_merge, vars.to.regress = c(\"percent.mt\", \"S.Score\", \"G2M.Score\"))\n\n\n### Azimuth annotation ####################################################################################\nlibrary(Azimuth)\n\nall_merge_azimuth &lt;- RunAzimuth(query = all_merge, reference = \"bonemarrowref\")\n\n#| add clinical info\nclin &lt;- read.table(\"../data/metadata2.txt\", header = T, sep = \"\\t\")\n\nall_merge_azimuth$cellid &lt;- rownames(all_merge_azimuth@meta.data)\nall_merge_azimuth$aux &lt;- paste0(all_merge_azimuth$samplename, all_merge_azimuth$demux_barcode) #id for clin merge\n\naux &lt;- inner_join(all_merge_azimuth@meta.data[,c(\"aux\", \"cellid\")], clin[,-2], by = \"aux\") #merge doesn't keep rows' order\nrownames(aux) &lt;- aux$cellid; aux$cellid &lt;- NULL\nall_merge_azimuth &lt;- AddMetaData(all_merge_azimuth, metadata = aux)\n\n#| remove some cells (n=3) with wrong/unmapped demux\nall_merge_azimuth &lt;- subset(all_merge_azimuth, subset = aux %in% c(\"SD-2520_1004_BL_ES_multiomeA0252\", \"SD-2752_1022_BL_ES_dogma_multiomeunmapped\"), invert = T)\n\n\n### UMAP ####\nall_merge_azimuth &lt;- RunPCA(all_merge_azimuth, verbose = F)\n\n# ElbowPlot(all_merge_azimuth)\nk = 18\n\nall_merge_azimuth &lt;- RunUMAP(all_merge_azimuth, n.components = 2,\n                dims = 1:k, n.neighbors = 10, min.dist = 0.6, \n                spread = 0.9, n.epochs = NULL) \n\n\naux_metadata &lt;- all_merge_azimuth$metadata[!is.na(all_merge_azimuth$metadata$timepoint),]\numap &lt;- u$umap\n\naux_metadata$BMI_change &lt;- ifelse(aux_metadata$BMI_12m &gt; 0.05, \"weight loss\", \"weight stable\")\naux_metadata$diversity_16S_diff &lt;- ifelse(aux_metadata$patient %in% c(1003, 1006, 1011, 1012, 1014), \"poorer\", \n                                               ifelse(aux_metadata$patient %in% c(1001, 1013, 1015, 1017, 1023), \"richer\", NA))\n\naux_metadata$predicted.celltype.l2_curated &lt;- factor(aux_metadata$predicted.celltype.l2_curated, levels = poporder)\nannot &lt;- aux_metadata[!duplicated(aux_metadata$patient),-grep(\"timepoint\", colnames(aux_metadata))]\n\nSupplemental Fig 4B:\n\n### - Supp Fig4B ----\nset.seed(333)\ndata.frame(Embeddings(umap), aux_metadata) %&gt;% \n  slice(sample(1:n())) %&gt;% #shuffle rows to avoid plotting in order and create false specific clusters\n  ggplot(aes(umap_1, umap_2, color = predicted.celltype.l2_curated)) + \n  geom_point(size = 1, alpha = 0.7) + \n  scale_color_manual(values = popcolor, name = \"\") +\n  guides(color = guide_legend(ncol = 2, size = 5)) + theme_bw() + \n  theme(legend.position = \"right\", legend.text = element_text(size = 10))\n\nSupplemental Fig 4C:\n\n### - Supp Fig4C ----\naux_props &lt;- aux_metadata %&gt;% \n  group_by(predicted.celltype.l2_curated, patient, timepoint) %&gt;%\n  summarize(n = n()) %&gt;% ungroup() %&gt;% \n  group_by(patient, timepoint) %&gt;% mutate(n_total = sum(n)) %&gt;% \n  ungroup() %&gt;% mutate(prop_global = n / n_total)\n\ndfstats_global &lt;- aux_props %&gt;% group_by(predicted.celltype.l2_curated) %&gt;%\n  distinct(timepoint, patient, predicted.celltype.l2_curated, .keep_all = T) %&gt;%\n  wilcox_test(prop_global ~ timepoint) %&gt;% arrange(p)\n\nggplot(aux_props, aes(predicted.celltype.l2_curated, prop_global, fill = timepoint)) + geom_boxplot() +\n  scale_fill_manual(values = c(\"azure3\", \"seagreen3\"), name = \"Timepoint\", labels = c(\"BL\", \"W52\")) +\n  annotate(\"rect\", xmin = c(1,10,19,26)-0.5, xmax = c(5,12,22,28)+0.5, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = \"gray50\") +\n  scale_color_manual(values = 1:2, name = \"significance\") + labs(y = \"cell proportions\\n(pseudo log-transf.)\\n\", x = NULL) +\n  scale_y_continuous(trans = scales::pseudo_log_trans(sigma = 0.01), breaks = c(seq(0,0.4, by = 0.1), 0.55,0.75,1), minor_breaks = NULL) + #better than log10, remove 0 values (inf)\n  guides(color = \"none\") + #ggtitle(\"global\") +\n  geom_text(inherit.aes = F, data = dfstats_global, aes(x = predicted.celltype.l2_curated, 0.95, label = round(p, digits = 2), color = if_else(p &lt;= 0.1, \"sig\", \"ns\")), size = 3) + \n  theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10), \n                     axis.text.y = element_text(size = 10))\n\nSupplemental Fig 4D/E:\n\n# W::same variable names for two different analysis\naux2 &lt;- merge(aux_props, annot) %&gt;% group_by(pops, timepoint, BMI_change) %&gt;% summarise(m = median(value, na.rm = T)) %&gt;%\n  subset(!pops %in% no_mypops)\nFC &lt;- data.frame(pops = unique(aux2$pops), \n                 loss = log2(aux2$m[aux2$BMI_change == \"weight loss\" & aux2$timepoint == \"ES\"]/\n                               aux2$m[aux2$BMI_change == \"weight loss\" & aux2$timepoint == \"BL\"]), \n                 stable = log2(aux2$m[aux2$BMI_change == \"weight stable\" & aux2$timepoint == \"ES\"]/\n                                 aux2$m[aux2$BMI_change == \"weight stable\" & aux2$timepoint == \"BL\"]))\nFC[is.na(FC)] &lt;- 0 #medians are 0, so ratio NA\nFC$color &lt;- ifelse(FC$pops %in% c(\"GMP\", \"CD14 monos\"), \"sig, weight loss\", \"\") #previous stats\n\n\naux2 &lt;- merge(aux_props, annot) %&gt;% group_by(pops, timepoint, diversity_16S_diff) %&gt;% summarise(m = median(value, na.rm = T)) %&gt;%\n  subset(!pops %in% no_mypops) %&gt;% subset(!is.na(diversity_16S_diff))\nFC &lt;- data.frame(pops = unique(aux2$pops), \n                 loss = log2(aux2$m[aux2$diversity_16S_diff == \"richer\" & aux2$timepoint == \"ES\"]/\n                               aux2$m[aux2$diversity_16S_diff == \"richer\" & aux2$timepoint == \"BL\"]), \n                 stable = log2(aux2$m[aux2$diversity_16S_diff == \"poorer\" & aux2$timepoint == \"ES\"]/\n                                 aux2$m[aux2$diversity_16S_diff == \"poorer\" & aux2$timepoint == \"BL\"]))\nFC[is.na(FC)] &lt;- 0 #medians are 0, so ratio NA\nFC$color &lt;- ifelse(FC$pops %in% c(\"GMP\"), \"sig, 16S poorer\", \n                   ifelse(FC$pops %in% c(\"NKs CD56 dim\"), \"sig, 16S poorer & richer\", \"\")) #from previous stats\n\n\nggplot(FC, aes(loss, stable, label = pops, color = color)) + \n  geom_vline(xintercept = 0, lty = 2, color = \"gray70\") + geom_hline(yintercept = 0, lty = 2, color = \"gray70\") + geom_abline(slope = 1, lty = 2, color = \"gray70\") +\n  geom_point(size = 5, alpha = 0.5) + scale_color_manual(values = c(1, \"orange2\", \"red3\"), labels = c(\"ns\", \"sig. in one condition\", \"sig. in both conditions\")) + #16S\n  ggrepel::geom_text_repel(max.overlaps = 1e3, fill = \"white\", color = 1, min.segment.length = 0, nudge_y = 0.2) + \n  labs(x = paste0(\"enriched at BL &lt;--- high \\u03b1-diversity ---&gt; enriched at W52\"), y = \"enriched at BL &lt;--- low \\u03b1-diversity ---&gt; enriched at W52\") +  ggtitle(\"microbiome (16S) diversity\") +\n  theme_bw()\n\nDifferential Expression Analysis/Processing:\n\n### DE analyses ###########################################################################################\nlibrary(clusterProfiler)\n\nIdents(all_merge_azimuth) &lt;- all_merge_azimuth$timepoint\n\nall_merge_azimuth$BMI_change &lt;- ifelse(all_merge_azimuth$BMI_12m &gt; 0.05, \"weight loss\", \"weight stable\")\nall_merge_azimuth$diversity_16S_diff &lt;- ifelse(all_merge_azimuth$patient %in% c(1003, 1006, 1011, 1012, 1014), \"S16.poorer\", \n                                          ifelse(all_merge_azimuth$patient %in% c(1001, 1013, 1015, 1017, 1023), \"S16.richer\", NA))\n\nall_merge_azimuth_subset &lt;- all_merge_azimuth[,!grepl(paste0(no_mypops, collapse = \"|\"), all_merge_azimuth$predicted.celltype.l2_curated)]\n\n# global \nall_merge_azimuth_pseudobulk &lt;- AggregateExpression(all_merge_azimuth_subset, assays = \"RNA\", return.seurat = T, \n    group.by = c(\"predicted.celltype.l2_curated\", \"patient\", \"timepoint\"))\nIdents(all_merge_azimuth_pseudobulk) &lt;- \"timepoint\"\n\ndegs_deseq_global &lt;- lapply(unique(all_merge_azimuth_pseudobulk$predicted.celltype.l2_curated), function(x){\n      print(x)\n      tryCatch({\n        aux &lt;- all_merge_azimuth_pseudobulk[,all_merge_azimuth_pseudobulk[[\"predicted.celltype.l2_curated\"]] == x]\n        \n        aux2 &lt;- FindMarkers(aux, ident.1 = \"ES\", test.use = \"DESeq2\")\n        return(data.frame(aux2, genename = rownames(aux2), pops = x))\n        }, error = function(er) return(NULL))\n}) %&gt;% do.call(rbind, .)\n\n\n# by condition\nmyvar &lt;- \"BMI_change\" #diversity_16S_diff\n\nall_merge_azimuth_pseudobulk &lt;- AggregateExpression(all_merge_azimuth_subset, assays = \"RNA\", return.seurat = T, \n  group.by = c(\"predicted.celltype.l2_curated\", \"patient\", \"timepoint\", myvar))\nIdents(all_merge_azimuth_pseudobulk) &lt;- \"timepoint\"\n\ndegs_deseq &lt;- lapply(unique(all_merge_azimuth_pseudobulk$predicted.celltype.l2_curated), function(x){\n  lapply(unique(all_merge_azimuth_pseudobulk[[myvar]][[1]]), function(y){\n    print(paste(x, \"-\", y))\n    tryCatch({\n      aux &lt;- all_merge_azimuth_pseudobulk[,all_merge_azimuth_pseudobulk[[\"predicted.celltype.l2_curated\"]] == x & \n                                                all_merge_azimuth_pseudobulk[[myvar]] == y]\n      \n      aux2 &lt;- FindMarkers(aux, ident.1 = \"ES\", test.use = \"DESeq2\")\n      return(data.frame(aux2, genename = rownames(aux2), pops = x, condition = y))\n      }, error = function(er) return(NULL))\n  }) %&gt;% do.call(rbind, .) \n}) %&gt;% do.call(rbind, .)\ndegs_deseq_BMI &lt;- degs_deseq\n# degs_deseq_16diff &lt;- degs_deseq\n\nSupplemental Fig 4F:\n\n### - Supp Fig4F ----\nmytable &lt;- degs_deseq_global[degs_deseq_global$p_val &lt;= 0.05,]\n\nmytable$FC_intervals &lt;- cut(abs(mytable$avg_log2FC), breaks = seq(0,10, by = 2))\nmytable$FC_intervals &lt;- ifelse(mytable$avg_log2FC &lt; 0, paste0(\"-\", mytable$FC_intervals), as.character(mytable$FC_intervals))\nmytable$pops &lt;- factor(mytable$pops, levels = unique(degs_deseq_global$pops))\n\nmelt(table(FC_intervals = mytable$FC_intervals, pops = mytable$pops)) %&gt;% \n    mutate(value = ifelse(grepl(\"-\", FC_intervals), -value, value), \n                 pops = factor(pops, levels = poporder)) %&gt;%\n    ggplot(aes(pops, value, fill = FC_intervals)) + geom_col() + \n    scale_fill_manual(values = c(pals::brewer.blues(8)[c(2,4,6,8)], pals::brewer.reds(8)[c(2,4,6,8)])) +\n    theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))\n\nSupplemental Fig 4G-H:\n\n### - Supp Fig4G-H ----\nmytable &lt;- degs_BMI_deseq[degs_BMI_deseq$p_val &lt;= 0.05,]\n\nmytable$FC_intervals &lt;- cut(abs(mytable$avg_log2FC), breaks = seq(0,10, by = 2))\nmytable$FC_intervals &lt;- ifelse(mytable$avg_log2FC &lt; 0, paste0(\"-\", mytable$FC_intervals), as.character(mytable$FC_intervals))\nmytable$pops &lt;- factor(mytable$pops, levels = unique(degs_BMI_deseq$pops))\n\nmelt(table(FC_intervals = mytable$FC_intervals, pops = mytable$pops, condition = mytable$condition)) %&gt;% \n    mutate(value = ifelse(grepl(\"-\", FC_intervals), -value, value), \n                 pops = factor(pops, levels = poporder)) %&gt;%\n    ggplot(aes(pops, value, fill = FC_intervals)) + geom_col() + facet_grid(. ~ condition) + \n    scale_fill_manual(values = c(pals::brewer.blues(8)[c(2,4,6,8)], pals::brewer.reds(8)[c(2,4,6,8)])) +\n    theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))\n\nGSEA analysis:\n\n### GSEA analyses #########################################################################################\n# global\ngenesets_hallmark &lt;- msigdbr::msigdbr(species = \"Homo sapiens\", category = \"H\")[,c(\"gs_name\", \"gene_symbol\")]\n\naux &lt;- split(degs_deseq_global, degs_deseq_global$pops, drop = TRUE)\ngseares_global &lt;- lapply(aux, function(x){\n  print(unique(x$pops))\n\n  aux &lt;- x[x$p_val &lt;= 0.05, c(\"genename\", \"avg_log2FC\")]\n  aux &lt;- sort(setNames(aux$avg_log2FC, aux$genename), decreasing = T)\n\n  tryCatch({\n    gsea &lt;- GSEA(aux, TERM2GENE = genesets_hallmark, minGSSize = 3, pvalueCutoff = 1)\n    return(data.frame(gsea, pops = unique(x$pops))) \n    }, error = function(er) return(NULL))\n}) %&gt;% do.call(rbind, .)\n\n\n# by condition\ncondition_degs &lt;- degs_deseq_traj3\n\naux &lt;- split(condition_degs, list(condition_degs$condition, condition_degs$pops), drop = TRUE)\ngseares &lt;- lapply(aux, function(x){\n    print(paste(unique(x$condition), \"-\", unique(x$pops)))\n\n    aux &lt;- x[x$p_val &lt;= 0.05, c(\"genename\", \"avg_log2FC\")]\n    aux &lt;- sort(setNames(aux$avg_log2FC, aux$genename), decreasing = T)\n\n  tryCatch({\n    gsea &lt;- GSEA(aux, TERM2GENE = genesets_hallmark, minGSSize = 3, pvalueCutoff = 1)\n    return(data.frame(gsea, condition = unique(x$condition), pops = unique(x$pops))) \n    }, error = function(er) return(NULL))\n}) %&gt;% do.call(rbind, .)\ngseares_degs_bulk_BMI &lt;- gseares\n# gseares_degs_bulk_16diff &lt;- gseares\n\nFigure 3E:\n\n### - Fig3E ----\nmypaths &lt;- c(\"HALLMARK_COMPLEMENT\", \"HALLMARK_IL6_JAK_STAT3_SIGNALING\", \n             \"HALLMARK_INFLAMMATORY_RESPONSE\", \"HALLMARK_INTERFERON_GAMMA_RESPONSE\", \n             \"HALLMARK_TNFA_SIGNALING_VIA_NFKB\")\n\n\ngseares_global %&gt;% subset(ID %in% mypaths & pops %in% mypops) %&gt;% \n  mutate(pops = factor(pops, levels = poporder), ID = factor(ID, levels = mypaths)) %&gt;%\n  arrange(-pvalue) %&gt;%\n  ggplot(aes(pops, ID, fill = NES, size = -log10(pvalue))) + coord_cartesian(clip = \"off\") +\n      geom_point(pch = 21, aes(color = if_else(pvalue &lt;= 0.1, \"sig\", \"ns\"), stroke = if_else(pvalue &lt;= 0.1, 0.7, 0.5))) + \n      scale_fill_gradient2(low = \"azure4\", mid = \"white\", high = \"seagreen3\", breaks = seq(-2, 2, by = 1)) +\n      scale_color_manual(values = c(\"gray90\", \"gray40\")) + guides(color = F) +\n      scale_size(range = c(0,9)) + labs(x = NULL, y = NULL) +\n      theme_bw() + theme(#axis.ticks.x = element_blank(), \n          axis.text.x = element_text(angle = 45, hjust = 1, size = 7), \n          axis.text.y = element_text(size = 7), \n          panel.border = element_blank(), legend.position = \"none\")\n\nFigure 4 I and J:\n\n### - Supp Fig4I-J ----\ngseares_degs_bulk_BMI %&gt;% subset(ID %in% mypaths & pops %in% mypops) %&gt;% arrange(-pvalue) %&gt;%\n  mutate(pops = factor(pops, levels = intersect(mypops, poporder)), \n         ID = factor(ID, levels = mypaths)) %&gt;% \n  ggplot(aes(condition, ID, fill = NES, size = -log10(pvalue))) + coord_cartesian(clip = \"off\") +\n  geom_point(pch = 21, aes(color = if_else(pvalue &lt;= 0.1, \"sig\", \"ns\"), stroke = if_else(pvalue &lt;= 0.1, 0.7, 0.5))) + \n  scale_fill_gradient2(low = \"azure4\", mid = \"white\", high = \"seagreen3\", breaks = seq(-2, 2, by = 1)) +\n  scale_color_manual(values = c(\"gray90\", \"red3\")) + guides(color = F) +\n  facet_grid(. ~ pops, drop = F, labeller = label_wrap_gen(width = 10)) + \n  scale_size(range = c(0,9)) + labs(x = NULL, y = NULL) +\n  theme_bw() + theme(axis.text.x = element_text(angle = 45, hjust = 1), \n                     panel.border = element_blank(), legend.position = \"right\")\n\nCell Chat Analysis:\n\n### cellchat analysis #####################################################################################\nlibrary(CellChat); future::plan(\"multisession\", workers = 6)\n\nIdents(all_merge_azimuth) &lt;- \"predicted.celltype.l2_curated\"\n\nmypops &lt;- c(\"GMP\", \"CD14 monos\", \"CD16 monos\", \"MDSC\", \"CD8 cytotox\", \"CD8 exhausted\", \"NKs CD56 dim\", \"NKs CD56 bright\")\n\nall_merge_azimuth_subset &lt;- all_merge_azimuth[,grepl(paste0(mypops, collapse = \"|\"), \n                all_merge_azimuth$predicted.celltype.l2_curated)]\n\n\n# prepare icellnet\naux &lt;- read.table(\"https://github.com/soumelis-lab/ICELLNET/raw/master/data/ICELLNETdb.tsv\", header = T, sep = \"\\t\", quote = \"\", row.names = NULL)\naux$name &lt;- paste0(aux$Family, \"..\", aux$Subfamily)\n\ninteraction_input &lt;- aux[,c(\"Ligand.1\", \"Receptor.1\", \"name\")]\ncolnames(interaction_input) &lt;- c(\"ligand\", \"receptor\", \"pathway_name\")\ngene_info &lt;- data.frame(Symbol = aux$Ligand.1)\n\ndb.icellnet &lt;- updateCellChatDB(db = interaction_input, gene_info = gene_info)\ndb.icellnet &lt;- updateCellChatDB(db = interaction_input, gene_info = NULL, species_target = \"human\")\n\n\n### run cellchat ####\naux_cellchat_all &lt;- sapply(USE.NAMES = T, simplify = F, c(\"BL\", \"ES\"), function(y){\n  print(y)\n  \n  aux &lt;- createCellChat(all_merge_azimuth_subset[,all_merge_azimuth_subset[[\"timepoint\"]] == y], \n    group.by = \"ident\", assay = \"RNA\")\n  aux@DB &lt;- db.icellnet #icellnet\n\n  aux &lt;- subsetData(aux) #mandatory\n  aux &lt;- identifyOverExpressedGenes(aux)\n  aux &lt;- identifyOverExpressedInteractions(aux)\n\n  aux &lt;- computeCommunProb(aux, type = \"triMean\")\n  aux &lt;- computeCommunProbPathway(aux)\n  aux &lt;- aggregateNet(aux)\n\n  aux &lt;- netAnalysis_computeCentrality(aux)\n})\n\ncellchat_all &lt;- mergeCellChat(aux_cellchat_all, add.names = c(\"BL\", \"ES\")) #fix pops differences between BL/ES\n\nSupplemental Figure 3F:\n\n### - Supp Fig3F ----\nnetVisual_diffInteraction(cellchat_all, weight.scale = T, \n    label.edge = F, vertex.size.max = 5, arrow.width = 2,\n    color.use = popcolor, color.edge = c(\"seagreen3\", \"azure3\"))\n\nSupplemental Figure 3G:\n\n### - Supp Fig3G ----\nnetVisual_aggregate(aux_cellchat_all$BL, signaling = \"Cytokine..TNF\", color.use = popcolor, \n    layout = \"chord\", vertex.label.cex = 1)\nnetVisual_aggregate(aux_cellchat_all$ES, signaling = \"Cytokine..TNF\", color.use = popcolor, \n    layout = \"chord\", vertex.label.cex = 1)\n\nSupplemental Figure 4K:\n\n### - Supp Fig4K ----\np1 &lt;- melt(cellchat_all@net[[\"ES\"]][[\"count\"]]-cellchat_all@net[[\"BL\"]][[\"count\"]]) %&gt;% \n  mutate(Var1 = factor(Var1, levels = poporder), Var2 = factor(Var2, levels = poporder)) %&gt;%\n  ggplot(aes(Var2, Var1, fill = value)) + geom_tile() +\n    scale_fill_gradient2(low = \"azure4\", mid = \"white\", high = \"seagreen3\") +\n    labs(y = \"Sources (sender)\", x = \"Targets (receiver)\") +\n    theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), \n      legend.position = \"bottom\")\n\np2 &lt;- rbind(data.frame(pops = rownames(cellchat_all@net[[\"ES\"]][[\"count\"]]), timepoint = \"ES\", \n         sources = rowSums(cellchat_all@net[[\"ES\"]][[\"count\"]])),\n    data.frame(pops = rownames(cellchat_all@net[[\"BL\"]][[\"count\"]]), timepoint = \"BL\", \n         sources = rowSums(cellchat_all@net[[\"BL\"]][[\"count\"]]))) %&gt;%\n  group_by(pops) %&gt;% \n  mutate(diff.sources = sources[timepoint == \"ES\"]-sources[timepoint == \"BL\"]) %&gt;%\n  melt() %&gt;% mutate(timepoint = ifelse(grepl(\"diff\", variable), \"diff\", timepoint), \n            variable = gsub(\"diff\\\\.\", \"\", variable)) %&gt;%\n  distinct() %&gt;% subset(timepoint == \"diff\") %&gt;%\n  mutate(pops = factor(pops, levels = poporder)) %&gt;% \n  ggplot(aes(value, pops, fill = value)) + geom_col(color = \"gray80\", linewidth = 0.2) + \n    labs(y = NULL, x = NULL) + guides(y = \"none\") + #scale_x_continuous(limits = c(-100,200)) + \n    scale_fill_gradient2(low = \"azure4\", mid = \"white\", high = \"seagreen3\") +\n    theme_bw() + theme(legend.position = \"none\", axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), \n        panel.grid.major = element_blank())\n\np3 &lt;- rbind(data.frame(pops = rownames(cellchat_all@net[[\"ES\"]][[\"count\"]]), timepoint = \"ES\", \n         targets = colSums(cellchat_all@net[[\"ES\"]][[\"count\"]])),\n    data.frame(pops = rownames(cellchat_all@net[[\"BL\"]][[\"count\"]]), timepoint = \"BL\", \n         targets = colSums(cellchat_all@net[[\"BL\"]][[\"count\"]]))) %&gt;%\n  group_by(pops) %&gt;% \n  mutate(diff.targets = targets[timepoint == \"ES\"]-targets[timepoint == \"BL\"]) %&gt;%\n  melt() %&gt;% mutate(timepoint = ifelse(grepl(\"diff\", variable), \"diff\", timepoint), \n            variable = gsub(\"diff\\\\.\", \"\", variable)) %&gt;%\n  distinct() %&gt;% subset(timepoint == \"diff\") %&gt;%\n  mutate(pops = factor(pops, levels = poporder)) %&gt;% \n  ggplot(aes(value, pops, fill = value)) + geom_col(color = \"gray80\", linewidth = 0.2) + coord_flip() +\n    scale_fill_gradient2(low = \"azure4\", mid = \"white\", high = \"seagreen3\") +\n    labs(x = NULL, y = NULL) + guides(x = \"none\") + #scale_x_continuous(limits = c(-100,200)) + \n    theme_bw() + theme(legend.position = \"none\", panel.grid.major = element_blank())\n\np3 + plot_spacer() + p1 + p2 + plot_layout(ncol = 2, heights = c(0.2, 1), widths = c(1.1,0.2))",
    "crumbs": [
      "Analyses",
      "RNA Seq Analysis"
    ]
  }
]